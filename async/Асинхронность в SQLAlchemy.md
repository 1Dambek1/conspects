
# Асинхронность в SQLAlchemy

Асинхронность в SQLAlchemy доступна начиная с версии 1.4. Она интегрируется с асинхронным программированием в Python через `asyncio`. Асинхронный API позволяет работать с базами данных в неблокирующем режиме, что особенно полезно в высоконагруженных системах.

---

## Основные понятия

1. **Асинхронный движок (`async_engine`)**  
   В SQLAlchemy асинхронный движок создаётся с использованием `create_async_engine`. Это асинхронный аналог обычного `create_engine`.

2. **Асинхронные сессии (`AsyncSession`)**  
   Асинхронная версия `Session`, которая используется для выполнения запросов в неблокирующем режиме.

3. **Асинхронный диспетчер соединений**  
   Для выполнения операций требуется явно открывать и закрывать соединения с помощью `async with`.

4. **Поддерживаемые драйверы**  
   Асинхронный API SQLAlchemy работает с драйверами, поддерживающими асинхронные операции, такими как:
   - `asyncpg` (для PostgreSQL)
   - `aiomysql` (для MySQL)
   - `sqlite+aiosqlite` (для SQLite)

---

## Принципы работы

1. **Асинхронный цикл событий**  
   Все операции выполняются внутри асинхронного цикла событий (`asyncio`). Для этого используется ключевое слово `await` при выполнении операций.

2. **Асинхронное соединение**  
   Все взаимодействия с базой данных происходят через асинхронные соединения, что позволяет не блокировать основной поток выполнения программы.

3. **Асинхронная ORM**  
   SQLAlchemy поддерживает асинхронные запросы как на уровне "сырых" SQL-запросов, так и на уровне ORM.

---

## Пример использования

### Установка асинхронного драйвера
Перед использованием нужно установить подходящий драйвер. Например, для PostgreSQL:
```bash
pip install asyncpg
```

### Асинхронный движок и сессия
```python
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from sqlalchemy.orm import sessionmaker

DATABASE_URL = "postgresql+asyncpg://user:password@localhost/dbname"

# Создание асинхронного движка
engine = create_async_engine(DATABASE_URL, echo=True)

# Создание фабрики сессий
async_session = sessionmaker(
    engine, expire_on_commit=False, class_=AsyncSession
)
```

### Выполнение запросов
```python
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.future import select

async def fetch_data():
    async with async_session() as session:
        async with session.begin():
            # Пример запроса
            result = await session.execute(select(MyTable).where(MyTable.id == 1))
            data = result.scalar()
            print(data)
```

### Работа с таблицами
```python
from sqlalchemy.orm import Mapped, mapped_column
from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()

class MyTable(Base):
    __tablename__ = "my_table"
    id:Mapped[int] =  mapped_column(Integer, primary_key=True)
    name:Mapped[str]
```

---

## Преимущества использования

1. **Эффективная обработка ввода-вывода**  
   Асинхронный API позволяет обрабатывать множество запросов к базе данных одновременно.

2. **Подходит для высоконагруженных приложений**  
   Асинхронный подход оптимизирует работу API, серверов и других приложений с большими потоками данных.

3. **Интеграция с асинхронным фреймворком**  
   Прекрасно работает с такими фреймворками, как FastAPI и Aiohttp.

---

## Ограничения

1. **Поддержка драйверов**  
   Не все базы данных и драйверы поддерживают асинхронные операции.

2. **Сложность отладки**  
   Асинхронные приложения могут быть сложнее для отладки, чем синхронные.

3. **Смешение синхронного и асинхронного кода**  
   Использование синхронного и асинхронного API SQLAlchemy в одном проекте требует внимательного управления циклами событий.

---

## Заключение

Асинхронный API SQLAlchemy предоставляет мощные инструменты для создания высокопроизводительных приложений. Использование асинхронности даёт значительное преимущество в обработке запросов и эффективном управлении ресурсами.
